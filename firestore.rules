rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin (requires admin collection setup)
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if user is admin or owner
    function isAdminOrOwner(userId) {
      return isAdmin() || isOwner(userId);
    }
    
    // Validate email format
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Validate phone number (Indian format)
    function isValidPhone(phone) {
      return phone.matches('^\\+91[0-9]{10}$') || phone.matches('^[0-9]{10}$');
    }
    
    // Validate pin code (Indian format)
    function isValidPinCode(pinCode) {
      return pinCode.matches('^[0-9]{6}$');
    }
    
    // ========================================================================
    // CARTS COLLECTION
    // ========================================================================
    
    match /carts/{userId} {
      // Users can read and write their own cart
      allow read: if isOwner(userId);
      
      // Users can create their own cart
      allow create: if isOwner(userId) && 
                       request.resource.data.userId == userId &&
                       request.resource.data.items is list &&
                       request.resource.data.subtotal is number &&
                       request.resource.data.tax is number &&
                       request.resource.data.shippingCost is number &&
                       request.resource.data.discount is number &&
                       request.resource.data.total is number;
      
      // Users can update their own cart
      allow update: if isOwner(userId) && 
                       request.resource.data.userId == userId;
      
      // Users can delete their own cart
      allow delete: if isOwner(userId);
    }
    
    // ========================================================================
    // ORDERS COLLECTION
    // ========================================================================
    
    match /orders/{orderId} {
      // Users can read their own orders, admins can read all
      allow read: if isAuthenticated() && 
                     (request.auth.uid == resource.data.userId || isAdmin());
      
      // Users can create orders for themselves
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId &&
                       validateOrderCreation();
      
      // Only admins can update orders
      allow update: if isAdmin() && validateOrderUpdate();
      
      // Only admins can delete orders
      allow delete: if isAdmin();
      
      // Validate order creation
      function validateOrderCreation() {
        let order = request.resource.data;
        return order.userId is string &&
               order.userEmail is string &&
               isValidEmail(order.userEmail) &&
               order.userPhone is string &&
               isValidPhone(order.userPhone) &&
               order.status in ['pending'] && // Only pending on creation
               order.paymentMethod in ['cod', 'online', 'upi', 'card', 'wallet'] &&
               order.paymentStatus in ['pending'] && // Only pending on creation
               order.items is list &&
               order.items.size() > 0 &&
               order.items.size() <= 100 && // Max 100 items per order
               order.pricing is map &&
               order.pricing.subtotal is number &&
               order.pricing.tax is number &&
               order.pricing.shippingCost is number &&
               order.pricing.discount is number &&
               order.pricing.total is number &&
               order.pricing.total > 0 &&
               validateAddress(order.shippingAddress) &&
               validateAddress(order.billingAddress) &&
               order.timeline is map &&
               order.timeline.placedAt is timestamp;
      }
      
      // Validate order update
      function validateOrderUpdate() {
        let order = request.resource.data;
        return order.userId == resource.data.userId && // Can't change user
               order.status in ['pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled', 'failed'] &&
               order.paymentStatus in ['pending', 'paid', 'failed', 'refunded'] &&
               validateStatusTransition(resource.data.status, order.status);
      }
      
      // Validate address object
      function validateAddress(address) {
        return address is map &&
               address.fullName is string &&
               address.fullName.size() > 0 &&
               address.phone is string &&
               isValidPhone(address.phone) &&
               address.addressLine1 is string &&
               address.addressLine1.size() > 0 &&
               address.city is string &&
               address.city.size() > 0 &&
               address.state is string &&
               address.state.size() > 0 &&
               address.pinCode is string &&
               isValidPinCode(address.pinCode) &&
               address.country is string &&
               address.country.size() > 0;
      }
      
      // Validate status transitions
      function validateStatusTransition(currentStatus, newStatus) {
        return (currentStatus == 'pending' && newStatus in ['confirmed', 'cancelled', 'failed']) ||
               (currentStatus == 'confirmed' && newStatus in ['processing', 'cancelled']) ||
               (currentStatus == 'processing' && newStatus in ['shipped', 'cancelled']) ||
               (currentStatus == 'shipped' && newStatus in ['delivered', 'failed']) ||
               (currentStatus == 'failed' && newStatus in ['pending']) ||
               (currentStatus == newStatus); // Allow same status (for other field updates)
      }
    }
    
    // ========================================================================
    // PRODUCTS COLLECTION (Existing - adjust as needed)
    // ========================================================================
    
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      
      // Only admins can create, update, or delete products
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================================================
    // ADMINS COLLECTION (For admin role management)
    // ========================================================================
    
    match /admins/{userId} {
      // Only admins can read admin list
      allow read: if isAdmin();
      
      // Only existing admins can create new admins
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================================================
    // USERS COLLECTION (Optional - for user profiles)
    // ========================================================================
    
    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isAdminOrOwner(userId);
      
      // Users can create and update their own profile
      allow create, update: if isOwner(userId);
      
      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }
    
    // ========================================================================
    // COUPONS COLLECTION (Future enhancement)
    // ========================================================================
    
    match /coupons/{couponCode} {
      // Anyone authenticated can read coupons (to validate)
      allow read: if isAuthenticated();
      
      // Only admins can create, update, or delete coupons
      allow create, update, delete: if isAdmin();
    }
    
    // ========================================================================
    // REVIEWS COLLECTION (Future enhancement)
    // ========================================================================
    
    match /reviews/{reviewId} {
      // Anyone can read reviews
      allow read: if true;
      
      // Users can create reviews for their own orders
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Users can update their own reviews, admins can update any
      allow update: if isAuthenticated() && 
                       (request.auth.uid == resource.data.userId || isAdmin());
      
      // Users can delete their own reviews, admins can delete any
      allow delete: if isAuthenticated() && 
                       (request.auth.uid == resource.data.userId || isAdmin());
    }
    
    // ========================================================================
    // NOTIFICATIONS COLLECTION (Future enhancement)
    // ========================================================================
    
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated() && 
                     request.auth.uid == resource.data.userId;
      
      // Only system/admins can create notifications
      allow create: if isAdmin();
      
      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() && 
                       request.auth.uid == resource.data.userId &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      // Only admins can delete notifications
      allow delete: if isAdmin();
    }
    
    // ========================================================================
    // DEFAULT DENY
    // ========================================================================
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
